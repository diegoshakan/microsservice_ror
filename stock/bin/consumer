#!/usr/bin/env ruby
require File.expand_path('../config/environment', __dir__)

connection = Bunny.new(automatically_recover: false)
connection.start

channel = connection.create_channel
queue = channel.queue("hello", auto_delete: false)

queue.bind(channel.exchange(queue.name))

puts "Consumindo"

begin
  puts ' [*] Waiting for messages. To exit press CTRL+C'
  # block: true is only used to keep the main thread
  # alive. Please avoid using it in real world applications.
  queue.subscribe(block: true) do |_delivery_info, _properties, body|
    body = JSON.parse(body)
    CreateItem.execute(body)
  end

end

begin
  while true
    sleep(3)
  end
rescue Interrupt
  connection.close
  puts "\nShutting down gracefully."
  exit
end
